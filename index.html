<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hounds and Jackals</title>
  <style>
    /* Basic Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #fafafa;
      font-family: "Papyrus", cursive, serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
    }
    h1, h2, p {
      text-align: center;
      color: #8b4513;
      margin: 10px 0;
    }

    /* Layout Wrapper */
    #gameWrapper {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 20px;
      width: 100%;
      margin: 20px;
    }

    /* Left Panel: Dice, Controls */
    #leftPanel {
      min-width: 150px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    button {
      font-size: 18px;
      margin: 10px;
      padding: 10px 20px;
      cursor: pointer;
      background: #ffcc00;
      border: none;
      border-radius: 6px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      color: #333;
      font-family: "Papyrus", cursive, serif;
    }
    #unusedRollBtn {
      display: none;
      margin: 5px;
      padding: 5px 10px;
      font-size: 16px;
      cursor: pointer;
      background: #ffcc00;
      border: none;
      border-radius: 6px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      color: #333;
      font-family: "Papyrus", cursive, serif;
    }
    #releaseControls { margin-top: 15px; }
    #releaseControls button {
      margin: 5px;
      padding: 5px 10px;
      font-size: 16px;
    }
    #offBoardCounts {
      margin-top: 10px;
      font-size: 16px;
    }

    /* Right Panel: Move History + Copy Button */
    #rightPanel {
      min-width: 200px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #moveHistory {
      font-size: 16px;
      padding: 10px;
      border: 2px solid #8b4513;
      border-radius: 6px;
      background: #fff;
      max-height: 400px;
      overflow-y: auto;
      width: 200px;
      text-align: left;
      user-select: text !important;
      white-space: pre-wrap;
      word-wrap: break-word;
      cursor: text;
      position: relative;
      z-index: 100;
    }
    #copyHistoryBtn {
      margin-top: 10px;
      padding: 5px 10px;
      font-size: 16px;
      cursor: pointer;
      background: #ffcc00;
      border: none;
      border-radius: 6px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      color: #333;
      font-family: "Papyrus", cursive, serif;
      z-index: 100;
    }

    /* Center Panel: The Game Container */
    #gameContainer {
      position: relative;
      width: 100%;
      max-width: 900px;
      padding: 20px 20px 80px 20px;
      background: linear-gradient(to bottom, #f5e6ca, #ecd8b5);
      border: 10px double #8b4513;
      border-radius: 6px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    canvas {
      display: block;
      margin: auto;
      background: radial-gradient(#fef9e7, #e8d6a4);
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }

    /* Overlay Screens: Menu, Instructions, Difficulty, Game Over */
    .overlayScreen {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.95);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
      border: 10px double #8b4513;
      border-radius: 6px;
      z-index: 10;
      overflow-y: auto;
    }
    .overlayScreen.active { display: flex; }
    #instructionsContent { font-size: 20px; margin: 10px; }
    #instructionsNav { margin-top: 10px; }

    /* Dice Display */
    #diceRollDisplay {
      font-size: 24px;
      padding: 10px;
      border: 2px solid #8b4513;
      border-radius: 6px;
      background: #fff;
      margin-bottom: 10px;
    }

    /* Temporary Message Overlay */
    #diceMessageOverlay {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      padding: 10px 20px;
      background: rgba(255,255,255,0.9);
      border: 2px solid #8b4513;
      border-radius: 6px;
      font-family: "Papyrus", cursive, serif;
      font-size: 28px;
      color: #8b4513;
      display: none;
      z-index: 1500;
    }

    /* Logo */
    #logo {
      position: fixed;
      bottom: 10px;
      right: 10px;
      max-width: 100px;
      z-index: 2000;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header-title">
    <h2>Another Product Invented</h2>
    <h1>Hounds and Jackals</h1>
  </div>

  <div id="gameWrapper">
    <!-- Left Panel -->
    <div id="leftPanel">
      <div id="diceRollDisplay">Dice: -</div>
      <button id="rollDiceBtn">Roll Dice</button>
      <button id="unusedRollBtn">Use Unused Roll</button>
      <input type="number" id="customDiceInput" min="1" max="6" placeholder="Set Dice (1-6)">
      <button id="setCustomDiceBtn">Use Custom Dice</button>

      <div id="releaseControls">
        <button id="releaseHoundBtn">Release Hound</button>
      </div>

      <div id="offBoardCounts">
        <span id="houndsCount">Hounds Off-board: 5</span><br>
        <span id="jackalsCount">Jackals Off-board: 5</span>
      </div>
    </div>

    <!-- Center Panel (Game Container) -->
    <div id="gameContainer">
      <div id="diceMessageOverlay"></div>

      <!-- Overlays -->
      <div id="menuScreen" class="overlayScreen active">
        <h1>Hounds and Jackals</h1>
        <button id="newGameBtn">New Game</button>
        <button id="instructionsBtn">Instructions</button>
      </div>

      <div id="instructionsScreen" class="overlayScreen">
        <div id="instructionsContent">Instructions go here</div>
        <div id="instructionsNav">
          <button id="instructionsPrevBtn">Previous</button>
          <button id="instructionsNextBtn">Next</button>
        </div>
      </div>

      <div id="difficultyScreen" class="overlayScreen">
        <p>Select AI Difficulty:</p>
        <button id="easyBtn">Easy</button>
        <button id="mediumBtn">Medium</button>
        <button id="hardBtn">Hard</button>
      </div>

      <div id="gameOverScreen" class="overlayScreen">
        <h2 id="gameOverText"></h2>
        <button id="gameOverNewGameBtn">New Game</button>
        <p>Press [M] to return to Main Menu</p>
      </div>

      <canvas id="gameCanvas" width="800" height="400"
              style="width: 800px; height: 400px; background: #fff;"></canvas>
    </div>

    <!-- Right Panel -->
    <div id="rightPanel">
      <div id="moveHistory" contenteditable="true">Moves:<br></div>
      <button id="copyHistoryBtn">Copy History</button>
    </div>
  </div>

  <img id="logo" src="logo.png" alt="Logo">

  <script>
    /* 
      In this minimal version:
      - We define a small set of squares to draw on the canvas (so you can "see" them).
      - We handle the overlays (menu, difficulty) so you can click through them.
      - We ensure dice never show 0 or negative (if a 0 would appear, we re-roll).
      - We display a minimal "Moves" log and an "Unused Roll" logic.
    */

    let aiTimeout = null;
    let lastTurnReported = "";

    // Make sure we always get a valid roll (1..6).
    function guaranteedRoll(val) {
      if (!val || val < 1 || val > 6) {
        return Math.floor(Math.random() * 6) + 1;
      }
      return val;
    }

    // Utility: remove white background from images.
    function removeWhiteBackground(image, callback) {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = image.width;
      tempCanvas.height = image.height;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.drawImage(image, 0, 0);
      const imgData = tempCtx.getImageData(0, 0, image.width, image.height);
      const data = imgData.data;
      for (let i = 0; i < data.length; i += 4) {
        if (data[i] >= 240 && data[i+1] >= 240 && data[i+2] >= 240) {
          data[i+3] = 0;
        }
      }
      tempCtx.putImageData(imgData, 0, 0);
      const newImage = new Image();
      newImage.src = tempCanvas.toDataURL();
      newImage.onload = () => callback(newImage);
    }

    window.addEventListener("load", function() {
      const debugMode = true;
      function debugLog(msg) { if (debugMode) console.log("[DEBUG]", msg); }
      debugLog("Page loaded. Initializing game...");

      // DOM references
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const diceRollDisplayEl = document.getElementById("diceRollDisplay");
      const rollDiceBtn = document.getElementById("rollDiceBtn");
      const unusedRollBtn = document.getElementById("unusedRollBtn");
      const moveHistoryDiv = document.getElementById("moveHistory");
      const menuScreenEl = document.getElementById("menuScreen");
      const instructionsScreenEl = document.getElementById("instructionsScreen");
      const difficultyScreenEl = document.getElementById("difficultyScreen");
      const gameOverScreenEl = document.getElementById("gameOverScreen");
      const gameOverTextEl = document.getElementById("gameOverText");
      const instructionsContentEl = document.getElementById("instructionsContent");
      const customDiceInput = document.getElementById("customDiceInput");
      const setCustomDiceBtn = document.getElementById("setCustomDiceBtn");
      const copyHistoryBtn = document.getElementById("copyHistoryBtn");

      let gameState = "menu",
          humanSide = "hounds",
          aiDifficulty = "medium",
          currentTurn = "hounds",
          currentDiceRoll = 0,
          diceRolled = false,
          extraTurn = false,
          nextPlayer = "jackals",
          NUM_PIECES = 5,
          houndsPieces = [],
          jackalsPieces = [],
          moveHistory = [],
          lastMove = null,
          unusedRoll = null,
          unusedRollOwner = null;

      // Minimal squares for demonstration
      const boardSquares = {
        A1: { x: 100, y: 100 },
        A2: { x: 160, y: 100 },
        A3: { x: 220, y: 100 },
        A4: { x: 280, y: 100 },
        A5: { x: 340, y: 100 },
        B1: { x: 100, y: 160 },
        B2: { x: 160, y: 160 },
        B3: { x: 220, y: 160 },
        B4: { x: 280, y: 160 },
        B5: { x: 340, y: 160 }
      };

      // Minimal piece arrays
      function initPieces() {
        houndsPieces = Array(NUM_PIECES).fill(-1);
        jackalsPieces = Array(NUM_PIECES).fill(-1);
        moveHistory = [];
        updateMoveHistoryDisplay();
        debugLog("Pieces reinitialized (5 each).");
      }

      // Minimal "drawBoard" that draws squares so you can see them
      function drawBoard() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        Object.entries(boardSquares).forEach(([label, sq]) => {
          // Draw circle
          ctx.beginPath();
          ctx.arc(sq.x, sq.y, 15, 0, 2*Math.PI);
          ctx.fillStyle = "#fcebbd";
          ctx.fill();
          ctx.strokeStyle = "#6b4e2e";
          ctx.lineWidth = 3;
          ctx.stroke();

          // Label
          ctx.fillStyle = "#000";
          ctx.font = "12px Arial";
          ctx.fillText(label, sq.x - 10, sq.y - 20);
        });
      }

      function drawPieces() {
        // In a real game, you'd locate each piece in boardSquares, etc.
        // For demonstration, we won't place them because all are -1 = offboard
        // But you can do real code here if needed
      }

      function redrawPlayScreen() {
        drawBoard();
        drawPieces();
        updateDiceRollDisplay();
        updateUnusedRollButton();
      }

      function rollDice() {
        return guaranteedRoll(Math.floor(Math.random() * 6) + 1);
      }
      function processDiceRoll(diceValue) {
        let val = guaranteedRoll(diceValue);
        debugLog("processDiceRoll: final roll = " + val);
        currentDiceRoll = val;
        diceRolled = true;
        addMoveToHistory(`${currentTurn} rolled ${val}`);
        showTemporaryMessage(`${currentTurn} rolled ${val}`);
        redrawPlayScreen();
        // For demonstration: if val == 6 => "has moves." Otherwise => pass unused roll
        if (val !== 6) {
          nextPlayer = (currentTurn === "hounds") ? "jackals" : "hounds";
          unusedRoll = val;
          unusedRollOwner = nextPlayer;
          addMoveToHistory(`${currentTurn} has no moves; roll (${val}) passed to ${nextPlayer}.`);
          diceRolled = false;
          currentDiceRoll = 0;
          currentTurn = nextPlayer;
          updateTurn();
        }
      }

      // Turn Handling
      function updateTurn() {
        currentDiceRoll = 0;
        diceRolled = false;
        addMoveToHistory(`${currentTurn}'s Turn! Roll dice...`);
        showTemporaryMessage(`${currentTurn}'s Turn! Roll dice...`);
        redrawPlayScreen();
        if (aiTimeout) clearTimeout(aiTimeout);
        if (currentTurn !== humanSide) {
          // Minimal AI logic
          aiTimeout = setTimeout(aiAutoRoll, 2000);
        }
      }
      function aiAutoRoll() {
        if (gameState !== "playing" || currentTurn === humanSide) return;
        if (unusedRoll !== null && unusedRollOwner === currentTurn) {
          let finalVal = guaranteedRoll(unusedRoll);
          processDiceRoll(finalVal);
          unusedRoll = null;
          unusedRollOwner = null;
        } else {
          let val = rollDice();
          processDiceRoll(val);
        }
      }

      // UI Buttons
      rollDiceBtn.addEventListener("click", () => {
        if (gameState !== "playing" || currentTurn !== humanSide || diceRolled) return;
        let val = rollDice();
        processDiceRoll(val);
      });
      unusedRollBtn.addEventListener("click", () => {
        if (unusedRoll !== null && unusedRollOwner === humanSide) {
          let finalVal = guaranteedRoll(unusedRoll);
          processDiceRoll(finalVal);
          unusedRoll = null;
          unusedRollOwner = null;
        }
      });
      setCustomDiceBtn.addEventListener("click", () => {
        if (gameState !== "playing" || currentTurn !== humanSide || diceRolled) return;
        let cVal = parseInt(customDiceInput.value);
        if (isNaN(cVal) || cVal < 1 || cVal > 6) {
          showTemporaryMessage("Invalid dice value!");
          return;
        }
        processDiceRoll(cVal);
      });

      // Minimal "releaseHound"
      document.getElementById("releaseHoundBtn").addEventListener("click", () => {
        showTemporaryMessage("ReleaseHound is not implemented in this demo!");
      });

      // Move History
      function updateMoveHistoryDisplay() {
        moveHistoryDiv.innerHTML = "Moves:<br>" + moveHistory.join("<br>");
      }
      function addMoveToHistory(txt) {
        moveHistory.push(txt);
        updateMoveHistoryDisplay();
        debugLog("addMoveToHistory: " + txt);
      }
      function updateDiceRollDisplay() {
        diceRollDisplayEl.textContent = `Dice: ${currentDiceRoll || "-"}`;
      }
      function updateUnusedRollButton() {
        if (gameState === "playing" && currentTurn === "hounds" && unusedRoll !== null && unusedRollOwner === "hounds") {
          unusedRollBtn.style.display = "inline-block";
          unusedRollBtn.textContent = "Use Unused Roll (" + unusedRoll + ")";
        } else {
          unusedRollBtn.style.display = "none";
        }
      }

      // Overlays
      function hideAllScreens() {
        menuScreenEl.style.display = "none";
        instructionsScreenEl.style.display = "none";
        difficultyScreenEl.style.display = "none";
        gameOverScreenEl.style.display = "none";
      }
      function showMenu() {
        hideAllScreens();
        menuScreenEl.style.display = "flex";
        gameState = "menu";
      }
      function showInstructions() {
        hideAllScreens();
        instructionsScreenEl.style.display = "flex";
        gameState = "instructions";
      }
      function showDifficultyScreen() {
        hideAllScreens();
        difficultyScreenEl.style.display = "flex";
        gameState = "selectDifficulty";
      }
      function setDifficulty(d) {
        aiDifficulty = d;
        startPlaying();
      }
      function startPlaying() {
        hideAllScreens();
        gameState = "playing";
        initPieces();
        currentTurn = "hounds";
        diceRolled = false;
        currentDiceRoll = 0;
        extraTurn = false;
        unusedRoll = null;
        unusedRollOwner = null;
        addMoveToHistory("Hounds Turn! Roll dice...");
        showTemporaryMessage("Hounds Turn! Roll dice...");
        redrawPlayScreen();
      }
      function showGameOver() {
        hideAllScreens();
        gameOverScreenEl.style.display = "flex";
        gameState = "gameover";
      }

      // Temporary Message
      function showTemporaryMessage(msg) {
        const overlay = document.getElementById("diceMessageOverlay");
        overlay.textContent = msg;
        overlay.style.display = "block";
        setTimeout(() => { overlay.style.display = "none"; }, 2000);
      }

      // Menu Buttons
      document.getElementById("newGameBtn").onclick = showDifficultyScreen;
      document.getElementById("instructionsBtn").onclick = showInstructions;
      document.getElementById("easyBtn").onclick = () => setDifficulty("easy");
      document.getElementById("mediumBtn").onclick = () => setDifficulty("medium");
      document.getElementById("hardBtn").onclick = () => setDifficulty("hard");
      document.getElementById("gameOverNewGameBtn").onclick = showDifficultyScreen;

      // Main game loop
      function mainLoop() {
        if (gameState === "playing") {
          redrawPlayScreen();
        }
        requestAnimationFrame(mainLoop);
      }

      // Start
      showMenu();
      requestAnimationFrame(mainLoop);
    });
  </script>
</body>
</html>
